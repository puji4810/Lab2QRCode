name: build and publish windows

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  windows-build:
    env:
      release_file: build/Release/bin/Lab2QRCode.exe
      release_dir: build/Release/bin/
      release_zip: Lab2QRCode.zip
      BOOST_ROOT: ./boost
    name: windows-latest
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # - name: Cache deps
      #   uses: actions/cache@v4
      #   id: cache-deps
      #   with:
      #     path: |
      #       deps
      #       boost
      #     key: deps-${{ runner.os }}-msvc-5.12.12-1.80.0

      - name: Setup MSVC Developer Command Prompt
        uses: TheMrMilchmann/setup-msvc-dev@v4
        with:
          arch: x64

      - name: Install Qt (Windows)
        uses: jurplel/install-qt-action@v4
        with:
          version: "5.12.12"
          target: "desktop"
          arch: "win64_msvc2017_64"
          install-deps: true
          dir: ${{ github.workspace }}/Qt

      - name: Install Boost
        id: install-boost
        uses: MarkusJx/install-boost@v2
        with:
          boost_version: 1.84.0
          boost_install_dir: ${{ github.workspace }}
          platform_version: 2022
          toolset: msvc

      - name: Install dependencies
        shell: pwsh
        run: |
          # åˆ›å»º deps ç›®å½•
          $depsDir = "${{ github.workspace }}\deps"
          New-Item -ItemType Directory -Path $depsDir -Force | Out-Null
          # ä¸‹è½½å¹¶é…ç½® OpenCV
            $opencvZip = "${{ github.workspace }}\deps\opencv.zip"
            $opencvDir = "${{ github.workspace }}\deps\OpenCV"
            Invoke-WebRequest "https://github.com/thommyho/Cpp-OpenCV-Windows-PreBuilts/releases/download/v4.12.0/MSVC142_64.zip" -OutFile $opencvZip
            Expand-Archive $opencvZip -DestinationPath $opencvDir
            Remove-Item $opencvZip

            $opencvConfig = "$opencvDir/OpenCVConfig.cmake"
          @'
          # Auto-generated OpenCVConfig.cmake
          set(OpenCV_INCLUDE_DIRS "${CMAKE_CURRENT_LIST_DIR}/Release/include")
          set(OpenCV_LIB_DIR "${CMAKE_CURRENT_LIST_DIR}/Release/lib")
          file(GLOB OpenCV_LIB_FILES "${OpenCV_LIB_DIR}/*.lib")
          add_library(OpenCV::OpenCV STATIC IMPORTED)
          list(GET OpenCV_LIB_FILES 0 first_lib)
          set_target_properties(OpenCV::OpenCV PROPERTIES
              IMPORTED_LOCATION "${first_lib}"
              INTERFACE_INCLUDE_DIRECTORIES "${OpenCV_INCLUDE_DIRS}"
              INTERFACE_LINK_LIBRARIES "${OpenCV_LIB_FILES}"
          )
          set(OpenCV_LIBS OpenCV::OpenCV)
          '@ | Out-File -FilePath $opencvConfig -Encoding UTF8 

          # æ„å»º zxing-cpp
          git clone --depth 1 https://github.com/zxing-cpp/zxing-cpp.git `
            ../zxing-cpp --recurse -b v2.3.0
            
          cmake -S ../zxing-cpp -B ../zxing-cpp/build -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build ../zxing-cpp/build --config Release
          cmake --install ../zxing-cpp/build --prefix "${{ github.workspace }}/deps"
          # Build spdlog
          git clone --depth 1 https://github.com/gabime/spdlog `
           ../spdlog --recurse -b v1.16.0
          cmake -S ../spdlog -B ../spdlog/build -G Ninja -DCMAKE_BUILD_TYPE=Release -DSPDLOG_BUILD_EXAMPLE=OFF -DSPDLOG_BUILD_TESTS=OFF SPDLOG_BUILD_SHARED=OFF
          cmake --build ../spdlog/build --config Release
          cmake --install ../spdlog/build --prefix "${{ github.workspace }}/deps"


        # ---------- Configure ----------
      - name: Configure CMake And Build Project
        shell: pwsh
        run: |
          Write-Host "Qtå®‰è£…è·¯å¾„: ${env:QT_ROOT_DIR}"

          # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
          if (Test-Path ${env:QT_ROOT_DIR}) {
              Write-Host "âœ… Qt æ ¹ç›®å½•å­˜åœ¨"
              Write-Host "ä¸€çº§ç›®å½•å†…å®¹:"
              Get-ChildItem -Path ${env:QT_ROOT_DIR} -Name
          } else {
              Write-Host "âŒ Qt æ ¹ç›®å½•ä¸å­˜åœ¨"
              exit 1
          }
          if (Test-Path ${env:BOOST_ROOT}) {
                        Write-Host "âœ… Boost æ ¹ç›®å½•å­˜åœ¨"
                        Write-Host "ä¸€çº§ç›®å½•å†…å®¹:"
                        Get-ChildItem -Path ${env:BOOST_ROOT} -Name
          } else {
              Write-Host "âŒ Boost æ ¹ç›®å½•ä¸å­˜åœ¨"
              exit 1
          }
          cmake -S . -B build -G "Ninja" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="${env:BOOST_ROOT};${env:QT_ROOT_DIR};./deps"

          cmake --build build --config Release --parallel

      # ---------- Check artifacts ----------
      - name: Check artifacts (Windows)
        shell: pwsh
        run: |
          Write-Host "æ„å»ºè¾“å‡ºç›®å½•å†…å®¹:"
          Get-ChildItem -Path "build" -Recurse -Include *.exe,*.dll | ForEach-Object { Write-Host $_.FullName }
          # éƒ¨ç½² Qt ä¾èµ–
          windeployqt "${{ env.release_file }}"

          Write-Host "ğŸ“¦ å‹ç¼©ç›®å½•: ${{ env.release_dir }}"
          if (Test-Path "${{ env.release_zip }}") {
            Remove-Item "${{ env.release_zip }}" -Force
          }
          Compress-Archive -Path "${{ env.release_dir }}*" -DestinationPath "${{ env.release_zip }}" -Force
          Write-Host "âœ… æ‰“åŒ…å®Œæˆ: ${{ env.release_zip }}"

        # 5ï¸âƒ£ ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Actionsï¼ˆè°ƒè¯•æŸ¥çœ‹ï¼‰
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: "${{ env.release_dir }}"

      # 6ï¸âƒ£ ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° GitHub Release éœ€è¦å¼€å¯è¯»å†™æƒé™
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag' 
        with:
          files: "${{ env.release_zip  }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ubuntu-build:
    env:
      release_exe: build/Release/bin/Lab2QRCode
      release_dir: build/Release/bin/
      release_zip: Lab2QRCode-linux.tar.gz

    name: Ubuntu GCC Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---- Install Dependencies ----
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qtbase5-dev qt5-qmake \
            libboost-all-dev \
            cmake ninja-build build-essential \
            libopencv-dev libspdlog-dev

      # ---- Build ZXing (Linux) ----
      - name: Build zxing-cpp
        run: |
          git clone https://github.com/zxing-cpp/zxing-cpp.git --depth 1
          cmake -S zxing-cpp -B zxing-cpp/build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF
          sudo cmake --build zxing-cpp/build --parallel
          sudo cmake --install zxing-cpp/build --prefix /usr/local

      # ---- Configure and Build Project ----
      - name: Configure and build project
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release

          cmake --build build --parallel

          tar -cvzf ${{ env.release_zip }} -C ${{ env.release_dir }} .

      # ---- Upload Build Artifacts ----
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: ${{ env.release_dir }}

      # ---- Publish Release (only when tag) ----
      - name: Upload Release Asset
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.release_zip }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}