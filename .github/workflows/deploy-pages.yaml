name: Deploy Lab2QRCode WASM to GitHub Pages

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    name: Build WASM + Frontend and Deploy
    runs-on: ubuntu-latest

    steps:
      # ==================== STEP 1: Checkout ====================
      - name: Checkout Lab2QRCode repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # ==================== STEP 2: Setup Emscripten ====================
      - name: Setup Emscripten SDK
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: '3.1.51'
          actions-cache-folder: 'emsdk-cache'

      # ==================== STEP 3: Build ZXing-cpp (WASM Dependency) ====================
      - name: Cache ZXing-cpp build
        id: cache-zxing
        uses: actions/cache@v4
        with:
          path: wasm-deps/
          key: zxing-wasm-${{ runner.os }}-${{ hashFiles('build-wasm-deps.sh') }}

      - name: Build ZXing-cpp for WASM
        if: steps.cache-zxing.outputs.cache-hit != 'true'
        run: |
          chmod +x build-wasm-deps.sh
          ./build-wasm-deps.sh
          
          # éªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸ
          echo "Verifying ZXing installation..."
          if [ -d "wasm-deps/install" ]; then
            echo "âœ“ Install directory exists"
            find wasm-deps/install -name "ZXingConfig.cmake" -ls
          else
            echo "âœ— Install directory not found!"
            exit 1
          fi
        shell: bash

      - name: Verify cached ZXing
        if: steps.cache-zxing.outputs.cache-hit == 'true'
        run: |
          echo "Using cached ZXing build"
          echo "Verifying cache integrity..."
          if find wasm-deps/install -name "ZXingConfig.cmake" | grep -q .; then
            echo "âœ“ ZXing config found in cache"
            find wasm-deps/install -name "ZXingConfig.cmake" -ls
          else
            echo "âœ— Cache is corrupted, forcing rebuild"
            rm -rf wasm-deps
            chmod +x build-wasm-deps.sh
            ./build-wasm-deps.sh
          fi
        shell: bash

      # ==================== STEP 4: Build Lab2QRCode WASM Module ====================
      - name: Build WASM Module
        run: |
          cd wasm-module
          
          # Clean build directory to avoid CMakeCache.txt path conflicts
          # (Repository has committed build artifacts with hardcoded local paths)
          rm -rf build
          mkdir -p build
          cd build
          
          # æŸ¥æ‰¾ ZXing CMake é…ç½®æ–‡ä»¶ï¼ˆä¼˜å…ˆä½¿ç”¨ install ç›®å½•ï¼‰
          ZXING_CMAKE_DIR=$(find $GITHUB_WORKSPACE/wasm-deps/install -name "ZXingConfig.cmake" -exec dirname {} \; | head -1)
          
          if [ -z "$ZXING_CMAKE_DIR" ]; then
            echo "Error: ZXingConfig.cmake not found in install directory!"
            echo "Searching all locations:"
            find $GITHUB_WORKSPACE/wasm-deps -name "ZXingConfig.cmake"
            exit 1
          fi
          
          echo "Using ZXing config at: $ZXING_CMAKE_DIR"
          
          emcmake cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DZXing_DIR="$ZXING_CMAKE_DIR"
          
          emmake make -j$(nproc)
          
          # éªŒè¯è¾“å‡ºæ–‡ä»¶
          ls -lh lab2qrcode.js lab2qrcode.wasm
        shell: bash

      - name: Copy WASM artifacts to frontend
        run: |
          mkdir -p web-frontend/public
          cp wasm-module/build/lab2qrcode.js web-frontend/public/
          cp wasm-module/build/lab2qrcode.wasm web-frontend/public/
          echo "âœ… WASM files copied to web-frontend/public/"
          ls -lh web-frontend/public/

      # ==================== STEP 5: Build React Frontend ====================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web-frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: web-frontend
        run: npm ci

      - name: Configure Vite base path for GitHub Pages
        working-directory: web-frontend
        run: |
          # åœ¨ vite.config.ts ä¸­æ³¨å…¥ base è·¯å¾„
          sed -i "/export default defineConfig({/a \ \ base: '/Lab2QRCode/'," vite.config.ts
          echo "=== vite.config.ts after modification ==="
          cat vite.config.ts

      - name: Build frontend
        working-directory: web-frontend
        run: npm run build

      # ==================== STEP 6: Configure for GitHub Pages ====================
      - name: Add GitHub Pages configuration
        working-directory: web-frontend/dist
        run: |
          # ç¦ç”¨ Jekyll å¤„ç†
          touch .nojekyll
          
          # SPA è·¯ç”±æ”¯æŒï¼ˆå¤åˆ¶ index.html ä¸º 404.htmlï¼‰
          cp index.html 404.html
          
          # æ·»åŠ  COOP/COEP headersï¼ˆGitHub Pages é€šè¿‡ _headers æ”¯æŒï¼‰
          cat > _headers << 'EOF'
          /*
            Cross-Origin-Opener-Policy: same-origin
            Cross-Origin-Embedder-Policy: require-corp
            Cross-Origin-Resource-Policy: cross-origin
          
          /*.wasm
            Content-Type: application/wasm
          EOF
          
          echo "âœ… GitHub Pages configuration complete"
          ls -la

      # ==================== STEP 7: Deploy ====================
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./web-frontend/dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # ==================== STEP 8: Summary ====================
      - name: Deployment Summary
        run: |
          echo "ğŸ‰ Deployment complete!"
          echo "ğŸ“¦ WASM Module: lab2qrcode.wasm ($(du -h wasm-module/build/lab2qrcode.wasm | cut -f1))"
          echo "ğŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}"
